# Generated Development Setup Workflow
# Project: {{ project_name }}
# Generated by BBX Application Generator

id: {{ project_name | lower | replace(' ', '_') }}_dev_setup
description: |
  Complete development environment setup for {{ project_name }}
  
  Features:
  - Dependency installation
  - Database initialization  
  - Docker containers (PostgreSQL, Redis)
  - Process management
  - Health checks
  - Development server startup

workflow:
  steps:
    # ========== Phase 1: Environment Setup ==========
    
    - id: welcome
      mcp: bbx.os
      method: echo
      inputs:
        message: |
          ðŸš€ Setting up {{ project_name }} Development Environment
          =========================================================
    
    - id: check_platform
      mcp: bbx.os
      method: platform_info
      inputs: {}
    
    # ========== Phase 2: Install Dependencies ==========
    
    - id: install_frontend_deps
      mcp: bbx.os
      method: exec
      inputs:
        command: "cd frontend && npm install"
        description: "Installing frontend dependencies"
      depends_on: [check_platform]
    
    - id: install_backend_deps
      mcp: bbx.os
      method: exec
      inputs:
        command: "cd backend && pip install -r requirements.txt"
        description: "Installing backend dependencies"
      depends_on: [check_platform]
      parallel: true
    
    # ========== Phase 3: Docker Services ==========
    
    - id: start_postgres
      mcp: bbx.docker
      method: run
      inputs:
        image: "postgres:15"
        name: "{{ project_name | lower }}_postgres"
        ports:
          - "5432:5432"
        environment:
          POSTGRES_USER: "postgres"
          POSTGRES_PASSWORD: "secret"
          POSTGRES_DB: "{{ project_name | lower }}_db"
        volumes:
          - "{{ project_name | lower }}_postgres_data:/var/lib/postgresql/data"
        detach: true
      depends_on: [install_backend_deps]
      on_error: continue
    
    - id: start_redis
      mcp: bbx.docker
      method: run
      inputs:
        image: "redis:7-alpine"
        name: "{{ project_name | lower }}_redis"
        ports:
          - "6379:6379"
        detach: true
      depends_on: [install_backend_deps]
      parallel: true
      on_error: continue
    
    # ========== Phase 4: Database Migration ==========
    
    - id: wait_for_db
      mcp: bbx.os
      method: exec
      inputs:
        command: "timeout /t 5 /nobreak > nul"  # Windows: wait 5 seconds
        # Linux: sleep 5
      depends_on: [start_postgres]
    
    - id: run_migrations
      mcp: bbx.os
      method: exec
      inputs:
        command: "cd backend && alembic upgrade head"
        description: "Running database migrations"
      depends_on: [wait_for_db]
      on_error: continue
    
    # ========== Phase 5: Start Development Servers ==========
    
    - id: start_backend_server
      mcp: bbx.process
      method: start
      inputs:
        name: "{{ project_name | lower }}_backend"
        command: "cd backend && python -m uvicorn app.main:app --reload --port 8000"
        auto_restart: true
        health_check:
          type: "http"
          url: "http://localhost:8000/health"
      depends_on: [run_migrations, start_redis]
    
    - id: start_frontend_server
      mcp: bbx.process
      method: start
      inputs:
        name: "{{ project_name | lower }}_frontend"
        command: "cd frontend && npm run dev"
        auto_restart: true
      depends_on: [install_frontend_deps]
      parallel: true
    
    # ========== Phase 6: Health Checks ==========
    
    - id: wait_for_servers
      mcp: bbx.os
      method: exec
      inputs:
        command: "timeout /t 3 /nobreak > nul"
      depends_on: [start_backend_server, start_frontend_server]
    
    - id: check_backend_health
      mcp: bbx.process
      method: health_check
      inputs:
        name: "{{ project_name | lower }}_backend"
      depends_on: [wait_for_servers]
    
    - id: check_frontend_health
      mcp: bbx.process
      method: health_check
      inputs:
        name: "{{ project_name | lower }}_frontend"
      depends_on: [wait_for_servers]
      parallel: true
    
    # ========== Phase 7: Status Report ==========
    
    - id: get_all_processes
      mcp: bbx.process
      method: status
      inputs: {}
      depends_on: [check_backend_health, check_frontend_health]
    
    - id: get_all_containers
      mcp: bbx.docker
      method: ps
      inputs:
        all: false
      depends_on: [check_backend_health, check_frontend_health]
      parallel: true
    
    - id: success_message
      mcp: bbx.os
      method: echo
      inputs:
        message: |
          
          âœ… {{ project_name }} Development Environment Ready!
          ====================================================
          
          Services Running:
          - Backend API: http://localhost:8000
          - Frontend: http://localhost:3000
          - PostgreSQL: localhost:5432
          - Redis: localhost:6379
          
          API Documentation: http://localhost:8000/docs
          
          To stop services:
          - Backend: bbx process stop {{ project_name | lower }}_backend
          - Frontend: bbx process stop {{ project_name | lower }}_frontend
          - Database: docker stop {{ project_name | lower }}_postgres
          - Redis: docker stop {{ project_name | lower }}_redis
          
          Happy coding! ðŸš€
      depends_on: [get_all_processes, get_all_containers]
